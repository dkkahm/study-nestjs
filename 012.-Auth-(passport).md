### install packages
- npm install @nestjs/passport passport passport-jwt
- npm install -D @types/passport-jwt

### import into module
```
import { PassportModule } from '@nestjs/passport';

@Module({
  imports: [
    PassportModule.register({ defaultStrategy: 'jwt' }),
    JwtModule.register({
      secret: 'topSecret51',
      signOptions: {
        expiresIn: 3600,
      },
    }),
    TypeOrmModule.forFeature([UserRepository]),
  ],
  ...
}
export class AuthModule {}
```

### JwtStrategy
- define
```
import { PassportStrategy } from '@nestjs/passport';
import { Strategy } from 'passport-strategy';
import { ExtractJwt } from 'passport-jwt';
import { InjectRepository } from '@nestjs/typeorm';
import { User } from './user.entity';
import { Repository } from 'typeorm';
import { UnauthorizedException, Injectable, HttpStatus } from '@nestjs/common';
import { Request } from 'express';
import { JwtService } from '@nestjs/jwt';
import { JsonWebTokenError } from 'jsonwebtoken';

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy, 'jwt') {
  constructor(
    @InjectRepository(User)
    private readonly userRepository: Repository<User>,
    private readonly jwtService: JwtService,
  ) {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      secretOrKey: 'topSecret51',
    });
  }

  async authenticate(req: Request) {
    try {
      const authorization = req.headers.authorization;

      if (!authorization.startsWith('Bearer '))
        throw new JsonWebTokenError('Invalid authorization');

      const token = authorization.substr(7);

      const payload = this.jwtService.verify(token);

      const { username } = payload;
      const user = await this.userRepository.findOne({ username });
      if (!user) {
        throw new JsonWebTokenError('user not exist');
      }

      this.success(user);
    } catch (error) {
      if (error instanceof JsonWebTokenError) {
        this.fail(HttpStatus.UNAUTHORIZED);
      } else {
        throw error;
      }
    }
  }
}
```
- import and export
```
@Module({
  imports: [
    PassportModule.register({ defaultStrategy: 'jwt' }),
    JwtModule.register({
      secret: 'topSecret51',
      signOptions: {
        expiresIn: 3600,
      },
    }),
    TypeOrmModule.forFeature([UserRepository]),
  ],
  controllers: [AuthController],
  providers: [AuthService, JwtStrategy],
  exports: [JwtStrategy, PassportModule],
})
export class AuthModule {}
```

### protect request handler
```
  @Post('/profile')
  @UseGuards(AuthGuard())
  profile(@Req() req) {
    console.log(req.user);
  }
```

### protect controller
```
@UseGuards(AuthGuard())
@Controller('/some')
export class SomeController {
```

### GetUser decorator
- define
```
import { createParamDecorator } from '@nestjs/common';
import { User } from './user.entity';

export const GetUser = createParamDecorator(
  (data, req): User => {
    return req.user;
  },
);
```
- use
```
  @Post('/test')
  @UseGuards(AuthGuard())
  test(@GetUser() user: User) {
    console.log(user);
  }
```

### use in other module
- import PassportModule and AuthModule
```
...
import { AuthModule } from 'src/auth/auth.module';
import { PassportModule } from '@nestjs/passport';

@Module({
  imports: [
    TypeOrmModule.forFeature([Task]),
    PassportModule.register({ defaultStrategy: 'jwt' }),
    AuthModule,
  ],
  controllers: [TasksController],
  providers: [TasksService],
})
export class TasksModule {}
```
- project handler
```
@Controller('tasks')
export class TasksController {
  ...
  @UseGuards(AuthGuard())
  @Get('/profile')
  profile(@Req() req) {
    console.log('xxxxxxxxxxxxxxxxxxx');
    return req.user;
  }
```
